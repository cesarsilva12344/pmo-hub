<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMO Hub | v15.0 Enterprise</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* CSS INTEGRADO PARA EVITAR ERROS DE CARREGAMENTO */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }

        .nav-item { border-left: 4px solid transparent; transition: all 0.2s; cursor: pointer; }
        .nav-item.active { background-color: #0f172a; color: #60a5fa; border-left-color: #3b82f6; font-weight: 600; }
        .nav-item:hover:not(.active) { background-color: #1e293b; color: white; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }

        .pmo-table th { background: #f8fafc; color: #64748b; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .pmo-table td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.875rem; }
        .form-label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
        .form-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.5rem; font-size: 0.875rem; }
        .form-input:focus { outline: none; border-color: #3b82f6; ring: 2px solid #bfdbfe; }

        .traffic-light { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tl-verde { background-color: #22c55e; }
        .tl-amarelo { background-color: #eab308; }
        .tl-vermelho { background-color: #ef4444; }

        .logo-filter-btn { transition: all 0.2s; border: 1px solid #e2e8f0; cursor: pointer; }
        .logo-filter-btn:hover { border-color: #bfdbfe; background-color: #f8fafc; }
        .logo-filter-btn.active { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; }

        .gantt-bar { height: 24px; border-radius: 4px; position: absolute; top: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); font-size: 0.75rem; color: white; display: flex; align-items: center; padding-left: 8px; overflow: hidden; white-space: nowrap; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .gantt-bar:hover { opacity: 0.9; }

        /* Matriz e Kanban */
        .risk-matrix { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 100px); gap: 2px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: #fff; }
        .risk-cell { display: flex; align-items: center; justify-content: center; position: relative; border: 1px dashed #f1f5f9; transition: all 0.2s; }
        .risk-cell:hover { opacity: 0.9; }
        .rc-low { background-color: #dcfce7; } .rc-med { background-color: #fef9c3; } .rc-high { background-color: #fee2e2; }
        .risk-dot { width: 24px; height: 24px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: absolute; cursor: pointer; transition: transform 0.2s; }
        .risk-dot:hover { transform: scale(1.2); z-index: 10; }

        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; height: 400px; }
        .kanban-col { background: #f8fafc; border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; border: 1px solid #e2e8f0; }
        .kanban-card { background: white; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.875rem; cursor: grab; border-left: 3px solid #3b82f6; }
        .kanban-card:active { cursor: grabbing; }
        .kanban-header { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800 text-base">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-slate-400 flex flex-col z-30 shadow-xl" id="sidebar">
        <div class="p-6 border-b border-slate-800 bg-slate-950 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold"><i class="fas fa-project-diagram"></i></div>
            <div><h1 class="text-lg font-bold text-white tracking-tight">PMO<span class="text-blue-500">Hub</span></h1><p class="text-[9px] uppercase tracking-widest font-semibold">v15.0 Ent</p></div>
        </div>

        <div class="py-4 border-b border-slate-800">
            <p class="px-6 text-[10px] font-bold text-slate-500 uppercase mb-2">Corporativo</p>
            <button onclick="goToPortfolio()" id="nav-portfolio" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3 text-sm active transition"><i class="fas fa-th-large w-5 text-center"></i> Portfólio</button>
            <button onclick="showTab('admin')" id="nav-admin" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3 text-sm transition hidden text-amber-400"><i class="fas fa-crown w-5 text-center"></i> Visão Admin</button>
        </div>

        <div id="project-nav" class="hidden flex-1 overflow-y-auto py-2">
            <div class="px-6 py-4 mb-2 bg-slate-800/50 border-b border-slate-800">
                <p class="text-[10px] text-blue-400 uppercase font-bold mb-1">Projeto Ativo</p>
                <p class="text-sm font-bold text-white truncate" id="sb-proj-name">--</p>
                <span id="sb-proj-type" class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-white mt-1 inline-block">Tradicional</span>
            </div>
            
            <p class="px-6 text-[10px] font-bold text-slate-500 uppercase mt-2 mb-2">Gestão</p>
            <button onclick="showTab('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-chart-pie w-5"></i> Dashboard</button>
            <button onclick="showTab('info')" id="nav-info" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-info-circle w-5 text-cyan-400"></i> Informações</button>
            <button onclick="showTab('gantt')" id="nav-gantt" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-calendar-alt w-5 text-amber-500"></i> Cronograma</button>
            <button onclick="showTab('kanban')" id="nav-kanban" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm hidden"><i class="fas fa-columns w-5 text-purple-400"></i> Kanban Ágil</button>
            <button onclick="showTab('lifecycle')" id="nav-lifecycle" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-stream w-5 text-indigo-400"></i> Ciclo de Vida</button>
            
            <p class="px-6 text-[10px] font-bold text-slate-500 uppercase mt-4 mb-2">Controle</p>
            <button onclick="showTab('financial')" id="nav-financial" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-coins w-5 text-green-400"></i> Financeiro</button>
            <button onclick="showTab('risks')" id="nav-risks" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-exclamation-triangle w-5 text-red-400"></i> Riscos (Matriz)</button>
            <button onclick="showTab('governance')" id="nav-governance" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-users w-5 text-pink-400"></i> Governança</button>
            
            <p class="px-6 text-[10px] font-bold text-slate-500 uppercase mt-4 mb-2">Ferramentas</p>
            <button onclick="showTab('canvas')" id="nav-canvas" class="nav-item w-full text-left px-6 py-2 flex gap-3 items-center text-sm"><i class="fas fa-bolt w-5 text-yellow-400"></i> One-Page</button>
        </div>

        <div class="mt-auto border-t border-slate-800 p-4">
            <button onclick="Auth.signOut()" class="w-full text-left px-2 py-2 text-xs text-red-400 hover:text-red-300 hover:bg-slate-800 rounded transition flex items-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Sair do Sistema
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-20">
            <div><h2 id="page-title" class="text-xl font-bold text-slate-800">Portfólio</h2><p class="text-xs text-slate-500">Gestão Estratégica Centralizada</p></div>
            <button onclick="openProjectModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition text-sm font-medium flex items-center gap-2"><i class="fas fa-plus"></i> Novo Projeto</button>
        </header>

        <div class="flex-1 overflow-y-auto p-8" id="main-scroll">
            
            <!-- PORTFOLIO VIEW -->
            <div id="view-portfolio" class="fade-in space-y-8">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0 items-center scrollbar-hide w-full md:w-auto" id="logo-filters"></div>
                        <div class="w-full md:w-64">
                            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">Filtrar por Nome</label>
                            <select id="text-filter" onchange="filterByName()" class="form-input w-full"><option value="all">Todos os Clientes</option></select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="card p-5 border-l-4 border-blue-500"><p class="text-xs font-bold text-slate-400 uppercase">Projetos Ativos</p><h3 class="text-2xl font-bold text-slate-800" id="kpi-total">...</h3></div>
                    <div class="card p-5 border-l-4 border-green-500"><p class="text-xs font-bold text-slate-400 uppercase">Faturamento (Real)</p><h3 class="text-2xl font-bold text-green-600 truncate" id="kpi-rev">...</h3></div>
                    <div class="card p-5 border-l-4 border-red-500"><p class="text-xs font-bold text-slate-400 uppercase">Riscos Críticos</p><h3 class="text-2xl font-bold text-red-600" id="kpi-risk">...</h3></div>
                    <div class="card p-5 border-l-4 border-amber-500"><p class="text-xs font-bold text-slate-400 uppercase">Alertas Gerais</p><h3 class="text-2xl font-bold text-amber-600" id="kpi-alerts">...</h3></div>
                </div>
                <div class="card overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between"><h3 class="font-bold text-slate-700">Listagem de Projetos</h3><span class="text-xs text-green-600 font-bold flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online (Auth)</span></div>
                    <div class="overflow-x-auto"><table class="w-full pmo-table"><thead><tr><th>Cliente</th><th>Projeto</th><th>Modelo</th><th>Status</th><th>Saúde</th><th>Financeiro</th><th class="text-right">Ação</th></tr></thead><tbody id="portfolio-body"></tbody></table></div>
                </div>
            </div>

            <!-- ADMIN VIEW -->
            <div id="view-admin" class="hidden fade-in space-y-8">
                <div class="bg-amber-50 border border-amber-200 p-6 rounded-xl">
                    <h2 class="text-xl font-bold text-amber-800 mb-2"><i class="fas fa-crown mr-2"></i>Área Administrativa</h2>
                    <p class="text-sm text-amber-700">Visão consolidada exclusiva para gestores de portfólio.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6"><h3 class="font-bold text-slate-700 mb-4">Investimento por Cliente</h3><canvas id="adminChart1"></canvas></div>
                    <div class="card p-6"><h3 class="font-bold text-slate-700 mb-4">Projetos por Metodologia</h3><canvas id="adminChart2"></canvas></div>
                </div>
            </div>

            <!-- PROJECT HUB VIEW -->
            <div id="view-project-hub" class="hidden space-y-6">
                <!-- DASHBOARD -->
                <div id="tab-dashboard" class="fade-in">
                    <div class="card p-6 mb-6 bg-white border-l-8 border-blue-600"><div class="flex justify-between items-start"><div class="flex gap-4"><div id="dash-logo" class="w-16 h-16 bg-slate-50 rounded-xl border border-slate-100 flex items-center justify-center text-3xl text-slate-600"></div><div><h2 class="text-2xl font-bold text-slate-800" id="dash-name">Projeto</h2><p class="text-sm text-slate-500 mt-1"><i class="fas fa-user-tie mr-1"></i> <span id="dash-pm">PM</span> | <i class="fas fa-building mr-1"></i> <span id="dash-client">Cliente</span></p></div></div><div class="flex gap-6"><div class="text-center group relative"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Prazo</p><div id="light-time" class="traffic-light"></div><div id="tip-time" class="hidden group-hover:block absolute right-0 w-48 bg-slate-800 text-white text-xs p-2 rounded shadow-lg z-10 text-left mt-2"></div></div><div class="text-center group relative"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Custo</p><div id="light-cost" class="traffic-light"></div><div id="tip-cost" class="hidden group-hover:block absolute right-0 w-48 bg-slate-800 text-white text-xs p-2 rounded shadow-lg z-10 text-left mt-2"></div></div><div class="text-center group relative"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Esforço</p><div id="light-hours" class="traffic-light"></div><div id="tip-hours" class="hidden group-hover:block absolute right-0 w-48 bg-slate-800 text-white text-xs p-2 rounded shadow-lg z-10 text-left mt-2"></div></div></div></div></div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="card p-6 lg:col-span-2"><h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-chart-line text-blue-500"></i> Curva S / Burndown</h4><div class="h-64"><canvas id="sCurveChart"></canvas></div></div><div class="space-y-6"><div class="card p-6"><h4 class="font-bold text-slate-700 mb-4">Financeiro Macro</h4><div class="space-y-3"><div class="flex justify-between text-sm border-b pb-2"><span>Previsto Total</span><span class="font-bold" id="dash-fin-plan">R$ 0,00</span></div><div class="flex justify-between text-sm border-b pb-2"><span>Realizado Total</span><span class="font-bold text-green-600" id="dash-fin-real">R$ 0,00</span></div><div class="flex justify-between text-sm"><span>Desvio</span><span class="font-bold text-slate-500" id="dash-fin-var">R$ 0,00</span></div></div></div><div class="card p-6"><h4 class="font-bold text-slate-700 mb-4">Ações Rápidas</h4><button onclick="showTab('risks')" class="w-full text-left text-sm p-2 hover:bg-slate-50 rounded text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i> Reportar Risco</button><button onclick="showTab('financial')" class="w-full text-left text-sm p-2 hover:bg-slate-50 rounded text-green-600"><i class="fas fa-coins mr-2"></i> Atualizar Financeiro</button></div></div></div>
                </div>

                <div id="tab-info" class="hidden fade-in"><div class="card p-8 max-w-5xl mx-auto"><h3 class="text-xl font-bold text-slate-800 mb-6 border-b pb-2">Informações do Projeto</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div><label class="form-label">Cliente</label><input type="text" id="info-client" class="form-input"></div><div><label class="form-label">Produto</label><input type="text" id="info-product" class="form-input"></div><div><label class="form-label">PEP (SAP)</label><input type="text" id="info-pep" class="form-input"></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div><label class="form-label">Responsável</label><input type="text" id="info-assignee" class="form-input"></div><div><label class="form-label">Relator</label><input type="text" id="info-reporter" class="form-input"></div><div><label class="form-label">Modalidade</label><select id="info-costmode" class="form-input"><option value="CAPEX">CAPEX</option><option value="OPEX">OPEX</option></select></div></div><div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6"><h4 class="text-sm font-bold text-blue-700 uppercase mb-4">Controle de Esforço (Horas)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="form-label">Horas Planejadas</label><input type="number" id="info-hours-plan" class="form-input font-bold"></div><div><label class="form-label">Horas Realizadas</label><input type="number" id="info-hours-real" class="form-input font-bold text-blue-600"></div></div></div><div class="text-right"><button onclick="saveProjectInfo()" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 transition">Salvar Dados</button></div></div></div>
                <div id="tab-gantt" class="hidden fade-in"><div class="card p-6"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-700">Cronograma</h3><button onclick="addTaskGantt()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded">Adicionar Tarefa</button></div><div class="overflow-x-auto border rounded border-slate-200"><div class="min-w-[800px]"><div class="grid grid-cols-12 bg-slate-100 border-b text-xs font-bold text-center py-2"><div>Jan</div><div>Fev</div><div>Mar</div><div>Abr</div><div>Mai</div><div>Jun</div><div>Jul</div><div>Ago</div><div>Set</div><div>Out</div><div>Nov</div><div>Dez</div></div><div id="gantt-rows" class="relative bg-white min-h-[300px] pt-2 px-2 space-y-2"></div></div></div></div></div>
                
                <div id="tab-kanban" class="hidden fade-in">
                    <div class="kanban-board">
                        <div class="kanban-col"><div class="kanban-header"><span>To Do (Backlog)</span><button onclick="addKanban('todo')" class="text-slate-400 hover:text-blue-600">+</button></div><div id="kb-todo" class="space-y-2 min-h-[200px]"></div></div>
                        <div class="kanban-col"><div class="kanban-header"><span>Doing (Sprint)</span><button onclick="addKanban('doing')" class="text-slate-400 hover:text-blue-600">+</button></div><div id="kb-doing" class="space-y-2 min-h-[200px]"></div></div>
                        <div class="kanban-col"><div class="kanban-header"><span>Done (Entrega)</span></div><div id="kb-done" class="space-y-2 min-h-[200px]"></div></div>
                    </div>
                </div>

                <div id="tab-risks" class="hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="font-bold text-slate-700 mb-4">Novo Risco</h3>
                            <div class="space-y-4 mb-6">
                                <input id="risk-desc" class="form-input" placeholder="Descrição do Risco">
                                <div class="grid grid-cols-2 gap-4"><div><label class="form-label">Probabilidade</label><select id="risk-prob" class="form-input"><option value="1">Baixa (1)</option><option value="2">Média (2)</option><option value="3">Alta (3)</option></select></div><div><label class="form-label">Impacto</label><select id="risk-imp" class="form-input"><option value="1">Baixo (1)</option><option value="2">Médio (2)</option><option value="3">Alto (3)</option></select></div></div>
                                <button onclick="addRiskMatrix()" class="w-full bg-red-600 text-white py-2 rounded font-bold shadow hover:bg-red-700">Registrar na Matriz</button>
                            </div>
                            <h4 class="font-bold text-sm text-slate-500 uppercase mb-2">Lista de Riscos</h4>
                            <div id="risk-list" class="space-y-2 h-64 overflow-y-auto"></div>
                        </div>
                        <div class="card p-6 flex flex-col items-center justify-center bg-slate-50">
                            <h3 class="font-bold text-slate-700 mb-6">Matriz de Calor</h3>
                            <div class="flex gap-2">
                                <div class="flex flex-col justify-between text-xs font-bold text-slate-400 h-[300px] py-8"><span>Alta</span><span>Média</span><span>Baixa</span></div>
                                <div class="risk-matrix w-[300px] h-[300px]">
                                    <div class="risk-cell rc-med" id="cell-3-1"></div><div class="risk-cell rc-high" id="cell-3-2"></div><div class="risk-cell rc-high" id="cell-3-3"></div>
                                    <div class="risk-cell rc-low" id="cell-2-1"></div><div class="risk-cell rc-med" id="cell-2-2"></div><div class="risk-cell rc-high" id="cell-2-3"></div>
                                    <div class="risk-cell rc-low" id="cell-1-1"></div><div class="risk-cell rc-low" id="cell-1-2"></div><div class="risk-cell rc-med" id="cell-1-3"></div>
                                </div>
                            </div>
                            <div class="flex justify-between w-[300px] ml-8 mt-2 text-xs font-bold text-slate-400"><span>Baixo</span><span>Médio</span><span>Alto</span></div>
                        </div>
                    </div>
                </div>

                <div id="tab-lifecycle" class="hidden fade-in"><div class="flex gap-2 overflow-x-auto mb-4 bg-white p-2 rounded shadow-sm"><button onclick="renderPhase('s2d')" class="px-4 py-2 rounded text-xs font-bold uppercase bg-slate-100 hover:bg-slate-200" id="ph-s2d">S2D</button><button onclick="renderPhase('init')" class="px-4 py-2 rounded text-xs font-bold uppercase bg-slate-100" id="ph-init">Iniciação</button><button onclick="renderPhase('plan')" class="px-4 py-2 rounded text-xs font-bold uppercase bg-slate-100" id="ph-plan">Planejamento</button><button onclick="renderPhase('exec')" class="px-4 py-2 rounded text-xs font-bold uppercase bg-slate-100" id="ph-exec">Execução</button><button onclick="renderPhase('mon')" class="px-4 py-2 rounded text-xs font-bold uppercase bg-slate-100" id="ph-mon">Monitoramento</button><button onclick="renderPhase('close')" class="px-4 py-2 rounded text-xs font-bold uppercase bg-slate-100" id="ph-close">Encerramento</button></div><div class="card p-6"><h3 class="font-bold text-lg text-slate-800 mb-4" id="ph-title">Checklist</h3><div id="ph-checklist" class="space-y-3"></div></div></div>
                <div id="tab-financial" class="hidden fade-in"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card p-6"><h3 class="font-bold text-slate-700 mb-4">Input da Curva S</h3><div class="overflow-y-auto max-h-[400px]"><table class="w-full text-sm text-left"><thead><tr class="border-b"><th class="py-2">Mês</th><th class="py-2">Previsto (R$)</th><th class="py-2">Realizado (R$)</th></tr></thead><tbody id="scurve-input-body"></tbody></table></div><button onclick="saveSCurveData()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded text-xs hover:bg-blue-700 w-full">Salvar Dados</button></div><div class="card p-6 h-fit"><h3 class="font-bold text-slate-700 mb-4">Orçamento Macro</h3><div class="space-y-4"><div><label class="form-label">Valor Setup</label><input type="number" id="fin-setup" class="form-input"></div><div><label class="form-label">Valor Sustentação</label><input type="number" id="fin-sustain" class="form-input"></div><button onclick="saveMacroFin()" class="bg-green-600 text-white px-4 py-2 rounded text-xs hover:bg-green-700 w-full">Salvar Macro</button></div></div></div></div>
                <div id="tab-governance" class="hidden fade-in space-y-6"><div class="card p-6"><div class="flex justify-between mb-4"><h3 class="font-bold text-pink-600">Stakeholders</h3><button onclick="addStake()" class="text-xs border px-2 rounded hover:bg-slate-50">Adicionar</button></div><table class="w-full pmo-table"><thead><tr><th>Nome</th><th>Papel</th><th>Ação</th></tr></thead><tbody id="stake-body"></tbody></table></div><div class="card p-6"><div class="flex justify-between mb-4"><h3 class="font-bold text-pink-600">Matriz RACI</h3><button onclick="addRaci()" class="text-xs border px-2 rounded hover:bg-slate-50">Adicionar</button></div><table class="w-full pmo-table"><thead><tr><th>Atividade</th><th>R</th><th>A</th><th>C</th><th>I</th><th></th></tr></thead><tbody id="raci-body"></tbody></table></div></div>
                <div id="tab-canvas" class="hidden fade-in"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">One-Page Canvas</h3><button onclick="window.print()" class="bg-white border px-3 py-1 rounded text-xs hover:bg-slate-50">Imprimir</button></div><div class="card p-6 mb-6"><div class="grid grid-cols-2 gap-4"><div><label class="form-label">Problema</label><textarea id="cv-pain" class="form-input h-20" oninput="saveCanvas()"></textarea></div><div><label class="form-label">Solução</label><textarea id="cv-obj" class="form-input h-20" oninput="saveCanvas()"></textarea></div></div></div><div class="one-page-canvas rounded shadow overflow-hidden bg-white"><div class="canvas-header"><h1 class="text-xl font-bold" id="cv-out-name">Projeto</h1><p class="text-xs opacity-70">PROJECT CHARTER</p></div><div class="canvas-cell col-span-2 border-r border-slate-200"><h4 class="text-xs font-bold text-slate-400">PROBLEMA</h4><p class="text-sm" id="cv-out-pain">...</p></div><div class="canvas-cell col-span-2"><h4 class="text-xs font-bold text-slate-400">SOLUÇÃO</h4><p class="text-sm" id="cv-out-obj">...</p></div><div class="canvas-cell col-span-4 border-t border-slate-200 bg-slate-50 flex justify-between text-xs"><span><strong>Previsto:</strong> <span id="cv-out-fin">R$ 0</span></span><span><strong>Realizado:</strong> <span id="cv-out-dev">R$ 0</span></span></div></div></div>
            </div>
        </div>
    </main>

    <!-- NOVO MODAL DE CRIAÇÃO -->
    <div id="modal-project" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white w-[500px] rounded-xl shadow-2xl p-6">
            <h3 class="text-lg font-bold mb-4">Novo Projeto</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input id="np-name" placeholder="Nome do Projeto" class="form-input">
                <input id="np-pm" placeholder="Gerente" class="form-input">
                <input id="np-client" placeholder="Cliente" class="form-input">
                <select id="np-model" class="form-input bg-blue-50 border-blue-200 text-blue-800 font-bold">
                    <option value="tradicional">Tradicional</option>
                    <option value="agil">Ágil (Kanban)</option>
                    <option value="quick">Quick Win</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-project')" class="text-sm px-4 py-2 text-slate-500">Cancelar</button>
                <button onclick="createProject()" class="text-sm px-4 py-2 bg-blue-600 text-white rounded">Criar</button>
            </div>
        </div>
    </div>

    <!-- Daily Timer -->
    <div id="modal-daily" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-50 backdrop-blur-sm"><div class="bg-white w-96 rounded-xl shadow-2xl overflow-hidden"><div class="bg-slate-800 p-4 text-white flex justify-between"><h3 class="font-bold">Daily Timer</h3><span id="timer" class="font-mono text-xl">15:00</span></div><div class="p-6 text-center"><p class="text-sm text-slate-500 mb-4">1. Ontem? 2. Hoje? 3. Impedimentos?</p><button onclick="startTimer()" class="bg-blue-600 text-white px-6 py-2 rounded-full">Iniciar</button><button onclick="closeModal('modal-daily')" class="block mx-auto mt-4 text-xs text-slate-400">Fechar</button></div></div></div>

    <!-- SCRIPTS CONSOLIDADOS PARA GARANTIR ORDEM DE EXECUÇÃO -->
    <script>
        // CONFIG
        const PMO_CONFIG = {
            SUPABASE_URL: 'https://pmrmbddwlwhohjbvkxmf.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtcm1iZGR3bHdob2hqYnZreG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjMzNDgsImV4cCI6MjA3OTgzOTM0OH0.Xk5hTWaiLKnJUfUv0ePFINUpwSBSg5qptVmswpMHdng'
        };

        // AUTH LOGIC
        const authClient = window.supabase.createClient(PMO_CONFIG.SUPABASE_URL, PMO_CONFIG.SUPABASE_KEY);
        const Auth = {
            userProfile: null,
            signIn: async (email, password) => { const { data, error } = await authClient.auth.signInWithPassword({ email, password }); if (error) throw error; return data; },
            signOut: async () => { await authClient.auth.signOut(); window.location.href = 'login.html'; },
            checkSession: async () => {
                const { data: { session } } = await authClient.auth.getSession();
                if (!session && !window.location.href.includes('login.html')) window.location.href = 'login.html';
                if (session) {
                    const { data: profile } = await authClient.from('profiles').select('*').eq('id', session.user.id).single();
                    Auth.userProfile = profile;
                }
                return session;
            },
            isAdmin: () => { return Auth.userProfile && Auth.userProfile.role === 'admin'; }
        };

        // METRICS LOGIC
        const PMO_Metrics = {
            calcularFarolCusto: (planejado, realizado) => { if (!planejado || planejado === 0) return 'verde'; const razao = realizado / planejado; if (razao <= 1.0) return 'verde'; if (razao <= 1.10) return 'amarelo'; return 'vermelho'; },
            calcularFarolPrazo: (tarefas) => { if (!tarefas || tarefas.length === 0) return 'verde'; const fimProjeto = Math.max(...tarefas.map(t => t.end)); const mesAtual = new Date().getMonth(); if (fimProjeto < mesAtual) return 'vermelho'; if (fimProjeto === mesAtual) return 'amarelo'; return 'verde'; },
            calcularFarolHoras: (horasPlan, horasReal) => { if (!horasPlan || horasPlan == 0) return 'verde'; const consumo = horasReal / horasPlan; if (consumo > 1.0) return 'vermelho'; if (consumo >= 0.9) return 'amarelo'; return 'verde'; },
            calcularScoreRisco: (prob, imp) => { return prob * imp; },
            formatarCompacto: (valor) => { return Intl.NumberFormat('pt-BR', { notation: "compact", style: "currency", currency: "BRL" }).format(valor); }
        };

        // APP LOGIC
        const supabaseClient = window.supabase.createClient(PMO_CONFIG.SUPABASE_URL, PMO_CONFIG.SUPABASE_KEY);
        let projects = []; let currentProjId = null; let activeLogoFilter = 'all'; let chartInstance = null; let timerInterval = null;
        const phases = { 's2d': ['Check-in Comercial', 'Riscos'], 'init': ['Kick-off', 'Stakeholders'], 'plan': ['WBS', 'Cronograma'], 'exec': ['Dev', 'Testes'], 'mon': ['Status Report', 'Change Log'], 'close': ['Aceite Final', 'Lições'] };
        const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        async function init() {
            try {
                const { data, error } = await supabaseClient.from('projects').select('*');
                if(error) throw error;
                projects = data && data.length > 0 ? data.map(row => row.content) : [];
                if (Auth.isAdmin()) { document.getElementById('nav-admin').classList.remove('hidden'); }
            } catch (err) { console.error(err); }
            renderPortfolio(); renderFilters();
        }

        async function save() {
            if (currentProjId) { const p = projects.find(x => x.id === currentProjId); await supabaseClient.from('projects').upsert({ id: p.id, content: p }); } else { for(const p of projects) await supabaseClient.from('projects').upsert({ id: p.id, content: p }); }
        }

        function renderAdminView() {
            const ctx1 = document.getElementById('adminChart1').getContext('2d');
            const ctx2 = document.getElementById('adminChart2').getContext('2d');
            const clients = {}; const models = { 'tradicional': 0, 'agil': 0, 'quick': 0 };
            projects.forEach(p => { const total = p.sCurve?.[p.sCurve.length-1]?.real || 0; if(!clients[p.client]) clients[p.client] = 0; clients[p.client] += total; const m = p.model || 'tradicional'; if(models[m] !== undefined) models[m]++; else models['tradicional']++; });
            if(window.adminChartInstance1) window.adminChartInstance1.destroy();
            if(window.adminChartInstance2) window.adminChartInstance2.destroy();
            window.adminChartInstance1 = new Chart(ctx1, { type: 'bar', data: { labels: Object.keys(clients), datasets: [{ label: 'Investimento (R$)', data: Object.values(clients), backgroundColor: '#3b82f6' }] } });
            window.adminChartInstance2 = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(models), datasets: [{ data: Object.values(models), backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981'] }] } });
        }

        function renderRiskMatrix() {
            const p = projects.find(x => x.id === currentProjId); const list = document.getElementById('risk-list'); list.innerHTML = ''; document.querySelectorAll('.risk-cell').forEach(c => c.innerHTML = ''); if(!p.risks) p.risks = [];
            p.risks.forEach((r, idx) => { if(r.type === 'issue') return; const score = PMO_Metrics.calcularScoreRisco(r.prob, r.imp); const color = score >= 6 ? 'text-red-600' : (score >= 3 ? 'text-amber-600' : 'text-green-600'); list.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 border rounded text-xs"><div><span class="font-bold ${color}">[${score}]</span> ${r.desc}</div><button onclick="turnIssue(${idx})" class="text-[10px] bg-white border px-2 py-1 hover:bg-red-50 text-red-500">Virar Issue</button></div>`; const cellId = `cell-${r.prob}-${r.imp}`; const cell = document.getElementById(cellId); if(cell) cell.innerHTML += `<div class="risk-dot" title="${r.desc}">${idx+1}</div>`; });
        }
        function addRiskMatrix() { const desc = document.getElementById('risk-desc').value; const prob = parseInt(document.getElementById('risk-prob').value); const imp = parseInt(document.getElementById('risk-imp').value); if(desc) { const p = projects.find(x => x.id === currentProjId); if(!p.risks) p.risks = []; p.risks.push({ desc, prob, imp, type: 'risk' }); save(); renderRiskMatrix(); document.getElementById('risk-desc').value = ''; } }
        function turnIssue(idx) { if(!confirm("Transformar em Issue?")) return; const p = projects.find(x => x.id === currentProjId); p.risks[idx].type = 'issue'; p.risks[idx].desc = "[ISSUE] " + p.risks[idx].desc; save(); renderRiskMatrix(); }

        function renderKanban() { const p = projects.find(x => x.id === currentProjId); if(!p.kanban) p.kanban = { todo: [], doing: [], done: [] }; ['todo', 'doing', 'done'].forEach(col => { const div = document.getElementById('kb-'+col); div.innerHTML = ''; p.kanban[col].forEach((item, idx) => { div.innerHTML += `<div class="kanban-card" draggable="true">${item}<button onclick="delKanban('${col}', ${idx})" class="float-right text-red-300">×</button></div>`; }); }); }
        function addKanban(col) { const t = prompt("Nova Tarefa:"); if(t) { const p = projects.find(x => x.id === currentProjId); if(!p.kanban) p.kanban = { todo: [], doing: [], done: [] }; p.kanban[col].push(t); save(); renderKanban(); } }
        function delKanban(col, idx) { const p = projects.find(x => x.id === currentProjId); p.kanban[col].splice(idx, 1); save(); renderKanban(); }

        function showTab(id) {
            document.querySelectorAll('#view-project-hub > div').forEach(d => d.classList.add('hidden'));
            const viewAdmin = document.getElementById('view-admin'); if(viewAdmin) viewAdmin.classList.add('hidden');
            document.querySelectorAll('#project-nav .nav-item').forEach(b => b.classList.remove('active'));
            if(id === 'admin') { document.getElementById('view-portfolio').classList.add('hidden'); document.getElementById('view-project-hub').classList.add('hidden'); document.getElementById('view-admin').classList.remove('hidden'); renderAdminView(); return; }
            const tab = document.getElementById('tab-'+id); if(tab) tab.classList.remove('hidden');
            const nav = document.getElementById('nav-'+id); if(nav) nav.classList.add('active');
            if(id === 'dashboard') renderDashboard(); if(id === 'info') loadInfoForm(); if(id === 'financial') renderSCurveInput(); if(id === 'lifecycle') renderPhase('s2d'); if(id === 'gantt') renderGantt(); if(id === 'kanban') renderKanban(); if(id === 'governance') renderGov(); if(id === 'canvas') loadCanvas(); if(id === 'risks') renderRiskMatrix();
        }

        function openProject(id) {
            currentProjId = id; const p = projects.find(x=>x.id===id);
            document.getElementById('view-portfolio').classList.add('hidden'); const viewAdmin = document.getElementById('view-admin'); if(viewAdmin) viewAdmin.classList.add('hidden');
            document.getElementById('view-project-hub').classList.remove('hidden'); document.getElementById('project-nav').classList.remove('hidden');
            document.getElementById('sb-proj-name').innerText = p.name;
            const model = p.model || 'tradicional'; const typeLabel = document.getElementById('sb-proj-type'); if(typeLabel) typeLabel.innerText = model.toUpperCase();
            const navGantt = document.getElementById('nav-gantt'); const navKanban = document.getElementById('nav-kanban');
            if (model === 'agil') { if(navGantt) navGantt.classList.add('hidden'); if(navKanban) navKanban.classList.remove('hidden'); } else { if(navGantt) navGantt.classList.remove('hidden'); if(navKanban) navKanban.classList.add('hidden'); }
            showTab('dashboard');
        }

        async function createProject() {
            const name = document.getElementById('np-name').value; if (!name) return alert("Nome obrigatório");
            const model = document.getElementById('np-model').value; const client = document.getElementById('np-client').value || 'Geral';
            const btn = document.querySelector("button[onclick='createProject()']"); btn.innerText = "Salvando..."; btn.disabled = true;
            const newId = Date.now(); 
            const newP = { id: newId, name, pm: document.getElementById('np-pm').value || 'Gerente', client, logo: "fas fa-building", model: model, fin: { setup: 0, sustain: 0 }, info: { hours_plan: 0, hours_real: 0, costmode: 'CAPEX' }, sCurve: Array(12).fill(0).map((_, i) => ({ month: months[i], plan: 0, real: 0 })), gantt: [], kanban: { todo: [], doing: [], done: [] }, risks: [], canvas: { pain: '', obj: '' }, stakeholders: [], raci: [], checks: {} };
            projects.push(newP);
            try { await supabaseClient.from('projects').upsert({ id: newId, content: newP }); closeModal('modal-project'); goToPortfolio(); renderFilters(); document.getElementById('np-name').value = ''; } catch (err) { console.error(err); alert("Erro ao salvar."); } finally { btn.innerText = "Criar"; btn.disabled = false; }
        }

        function goToPortfolio() { document.getElementById('view-portfolio').classList.remove('hidden'); document.getElementById('view-project-hub').classList.add('hidden'); const viewAdmin = document.getElementById('view-admin'); if(viewAdmin) viewAdmin.classList.add('hidden'); document.getElementById('project-nav').classList.add('hidden'); renderPortfolio(); }
        function renderPortfolio() { const tb = document.getElementById('portfolio-body'); tb.innerHTML = ''; if (projects.length === 0) return tb.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-400">Sem projetos.</td></tr>'; const filtered = activeLogoFilter === 'all' ? projects : projects.filter(p => p.client === activeLogoFilter); filtered.forEach(p => { const lastReal = p.sCurve?.[p.sCurve.length-1]?.real || 0; const info = p.info || {}; tb.innerHTML += `<tr class="border-b hover:bg-slate-50"><td><div class="flex items-center gap-2"><i class="${p.logo}"></i> <span class="font-bold">${p.client}</span></div></td><td><div class="font-bold">${p.name}</div></td><td><span class="text-xs bg-slate-200 px-2 rounded">${p.model || 'Trad'}</span></td><td><span class="bg-blue-100 text-blue-700 px-2 font-bold text-xs">Ativo</span></td><td><div class="flex gap-1"><div class="traffic-light tl-${info.time||'verde'}"></div><div class="traffic-light tl-${info.cost||'verde'}"></div></div></td><td><div class="text-xs font-bold text-blue-600">${formatCurrency(lastReal)}</div></td><td class="text-right"><button onclick="openProject(${p.id})" class="text-xs border px-2 py-1 rounded hover:bg-slate-100 mr-2">Abrir</button><button onclick="deleteProject(${p.id})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`; }); }
        function renderDashboard() { const p = projects.find(x=>x.id===currentProjId); const info = p.info || {}; document.getElementById('dash-name').innerText = p.name; document.getElementById('dash-pm').innerText = p.pm; document.getElementById('dash-client').innerText = p.client; const ultimoMesComDados = p.sCurve.filter(m => m.real > 0).pop() || { plan: 0, real: 0 }; const corFarolCusto = PMO_Metrics.calcularFarolCusto(ultimoMesComDados.plan, ultimoMesComDados.real); const corFarolPrazo = PMO_Metrics.calcularFarolPrazo(p.gantt); const corFarolHoras = PMO_Metrics.calcularFarolHoras(info.hours_plan, info.hours_real); document.getElementById('light-time').className = `traffic-light tl-${corFarolPrazo} mt-1`; document.getElementById('light-cost').className = `traffic-light tl-${corFarolCusto} mt-1`; document.getElementById('light-hours').className = `traffic-light tl-${corFarolHoras} mt-1`; if (chartInstance) chartInstance.destroy(); const ctx = document.getElementById('sCurveChart').getContext('2d'); chartInstance = new Chart(ctx, { type: 'line', data: { labels: p.sCurve.map(d=>d.month), datasets: [{ label: 'Realizado', data: p.sCurve.map(d=>d.real), borderColor: '#2563eb' }] }, options: { maintainAspectRatio: false } }); }
        async function deleteProject(id) { if(!confirm("Excluir projeto?")) return; try { await supabaseClient.from('projects').delete().eq('id', id); projects = projects.filter(p => p.id !== id); renderPortfolio(); if(currentProjId === id) goToPortfolio(); } catch (err) { alert("Erro ao excluir."); } }
        function loadInfoForm() { const p = projects.find(x=>x.id===currentProjId); if(!p.info) p.info = {}; ['client','product','pep','assignee','reporter','costmode'].forEach(f => { document.getElementById('info-'+f).value = p.info[f] || ''; }); document.getElementById('info-hours-plan').value = p.info.hours_plan || 0; document.getElementById('info-hours-real').value = p.info.hours_real || 0; }
        function saveProjectInfo() { const p = projects.find(x=>x.id===currentProjId); if(!p.info) p.info = {}; ['client','product','pep','assignee','reporter','costmode'].forEach(f => { p.info[f] = document.getElementById('info-'+f).value; }); p.info.hours_plan = parseFloat(document.getElementById('info-hours-plan').value) || 0; p.info.hours_real = parseFloat(document.getElementById('info-hours-real').value) || 0; p.client = document.getElementById('info-client').value; save(); alert('Dados Salvos!'); renderDashboard(); }
        function renderGantt() { const p = projects.find(x=>x.id===currentProjId); const container = document.getElementById('gantt-rows'); container.innerHTML = ''; container.innerHTML = `<div class="absolute inset-0 grid grid-cols-12 pointer-events-none h-full"><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div><div class="border-r border-slate-100 h-full"></div></div>`; p.gantt.forEach(task => { const width = (task.end - task.start) * (100/12); const left = task.start * (100/12); container.innerHTML += `<div class="relative h-10 flex items-center z-10 mb-2 group"><div class="gantt-bar bg-amber-500 hover:bg-amber-600 text-white shadow-md text-xs font-bold pl-2" style="left: ${left}%; width: ${width}%">${task.name}</div></div>`; }); }
        function addTaskGantt() { const name = prompt("Nome da Tarefa:"); const start = parseInt(prompt("Mês Início (0-11):")); const end = parseInt(prompt("Mês Fim (0-11):")); if(name) { projects.find(x=>x.id===currentProjId).gantt.push({name, start, end}); save(); renderGantt(); } }
        function renderPhase(ph) { const p = projects.find(x=>x.id===currentProjId); const checklist = phases[ph]; const titleMap = {'s2d':'S2D', 'init':'Iniciação', 'plan':'Planejamento', 'exec':'Execução', 'mon':'Monitoramento', 'close':'Encerramento'}; document.getElementById('ph-title').innerText = titleMap[ph]; document.querySelectorAll('#tab-lifecycle button').forEach(b => b.classList.remove('bg-indigo-600', 'text-white')); document.getElementById('ph-'+ph).classList.add('bg-indigo-600', 'text-white'); const div = document.getElementById('ph-checklist'); div.innerHTML = ''; checklist.forEach((item, i) => { const key = ph + '_' + i; const checked = p.checks && p.checks[key] ? 'checked' : ''; div.innerHTML += `<label class="flex items-center p-3 border rounded bg-white hover:bg-slate-50 cursor-pointer"><input type="checkbox" onchange="toggleCheck('${key}', '${ph}')" ${checked} class="mr-3"> <span class="${checked?'line-through text-slate-400':''}">${item}</span></label>`; }); }
        function toggleCheck(key, ph) { const p = projects.find(x=>x.id===currentProjId); if(!p.checks) p.checks = {}; p.checks[key] = !p.checks[key]; save(); renderPhase(ph); }
        function renderSCurveInput() { const p = projects.find(x=>x.id===currentProjId); const tbody = document.getElementById('scurve-input-body'); tbody.innerHTML = ''; p.sCurve.forEach((row, i) => { tbody.innerHTML += `<tr class="border-b"><td class="py-2 px-4">${row.month}</td><td class="py-2 px-4"><input type="number" onchange="updateSCurve(${i}, 'plan', this.value)" value="${row.plan}" class="form-input w-32 py-1"></td><td class="py-2 px-4"><input type="number" onchange="updateSCurve(${i}, 'real', this.value)" value="${row.real}" class="form-input w-32 py-1"></td></tr>`; }); document.getElementById('fin-setup').value = p.fin.setup; document.getElementById('fin-sustain').value = p.fin.sustain; }
        function updateSCurve(idx, field, val) { projects.find(x=>x.id===currentProjId).sCurve[idx][field] = parseFloat(val); save(); }
        function saveSCurveData() { save(); alert('Gráfico Atualizado!'); }
        function saveMacroFin() { const p = projects.find(x=>x.id===currentProjId); p.fin.setup = parseFloat(document.getElementById('fin-setup').value); p.fin.sustain = parseFloat(document.getElementById('fin-sustain').value); save(); alert('Salvo!'); }
        function renderGov() { const p = projects.find(x=>x.id===currentProjId); document.getElementById('stake-body').innerHTML = p.stakeholders.map((s,i)=>`<tr><td>${s.n}</td><td>${s.r}</td><td><button onclick="delStake(${i})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`).join(''); document.getElementById('raci-body').innerHTML = p.raci.map((r,i)=>`<tr><td>${r.a}</td><td>${r.r}</td><td>${r.ac}</td><td>${r.c}</td><td>${r.i}</td><td><button onclick="delRaci(${i})" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
        function addStake() { const n=prompt("Nome:"); if(n) { projects.find(x=>x.id===currentProjId).stakeholders.push({n, r:'-'}); save(); renderGov(); }}
        function delStake(i) { projects.find(x=>x.id===currentProjId).stakeholders.splice(i,1); save(); renderGov(); }
        function addRaci() { const a=prompt("Atividade:"); if(a) { projects.find(x=>x.id===currentProjId).raci.push({a,r:'X',ac:'',c:'',i:''}); save(); renderGov(); }}
        function delRaci(i) { projects.find(x=>x.id===currentProjId).raci.splice(i,1); save(); renderGov(); }
        function loadCanvas() { const p = projects.find(x=>x.id===currentProjId); document.getElementById('cv-pain').value = p.canvas.pain; document.getElementById('cv-obj').value = p.canvas.obj; document.getElementById('cv-out-name').innerText = p.name; document.getElementById('cv-out-pain').innerText = p.canvas.pain; document.getElementById('cv-out-obj').innerText = p.canvas.obj; const last = p.sCurve[p.sCurve.length-1]; document.getElementById('cv-out-fin').innerText = formatCurrency(last.plan); document.getElementById('cv-out-dev').innerText = formatCurrency(last.plan - last.real); }
        function saveCanvas() { const p = projects.find(x=>x.id===currentProjId); p.canvas.pain = document.getElementById('cv-pain').value; p.canvas.obj = document.getElementById('cv-obj').value; save(); loadCanvas(); }
        function openProjectModal() { document.getElementById('modal-project').classList.remove('hidden'); }
        function openDailyModal() { document.getElementById('modal-daily').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function startTimer() { let sec = 900; if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { sec--; document.getElementById('timer').innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`; if(sec<=0) clearInterval(timerInterval); }, 1000); }
        function filterLogo(c) { activeLogoFilter = c; renderPortfolio(); }
        function filterByName() { const val = document.getElementById('text-filter').value; filterLogo(val); }

        window.onload = async () => {
            await Auth.checkSession();
            init();
        };
    </script>
</body>
</html>